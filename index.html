<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebecca AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .header {
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .status {
            padding: 10px 20px;
            background: #f0f8ff;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
            color: #2d3748;
        }

        .status.connected {
            background: #f0fff4;
            color: #38a169;
        }

        .status.error {
            background: #fff5f5;
            color: #e53e3e;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
        }

        .message.assistant {
            align-self: flex-start;
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .message.system {
            align-self: center;
            background: #fed7d7;
            color: #c53030;
            font-size: 12px;
            max-width: 90%;
        }

        .typing {
            align-self: flex-start;
            background: #f7fafc;
            color: #718096;
            font-style: italic;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .input-container {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e2e8f0;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #5a67d8;
        }

        .send-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .config-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .config-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
        }

        .connect-button {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .connect-button:hover {
            background: #38a169;
        }

        .suggestions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion {
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #4a5568;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #718096;
            font-size: 14px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .login-input:focus {
            border-color: #667eea;
        }

        .login-button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .login-button:hover {
            background: #5a67d8;
        }

        .login-error {
            color: #e53e3e;
            font-size: 12px;
            margin-top: 10px;
        }

        /* Admin Panel Styles */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .admin-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-admin {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #718096;
        }

        .user-list {
            margin-bottom: 20px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .remove-user {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-user-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .api-keys-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .admin-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>🤖 Rebecca AI</h1>
                <p>Secure Login Required</p>
            </div>
            <form class="login-form" id="loginForm">
                <input type="email" id="loginEmail" class="login-input" placeholder="Email" required>
                <input type="password" id="loginPassword" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-button">Sign In</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>Admin Panel</h2>
                <button class="close-admin" onclick="closeAdminPanel()">×</button>
            </div>
            
            <div class="user-list">
                <h3>Whitelisted Users</h3>
                <div id="userList"></div>
            </div>
            
            <div class="add-user-form">
                <h3>Add New User</h3>
                <input type="email" id="newUserEmail" class="login-input" placeholder="Email">
                <input type="password" id="newUserPassword" class="login-input" placeholder="Password">
                <button type="button" onclick="addUser()" class="login-button">Add User</button>
            </div>
            
            <div class="api-keys-section">
                <h3>API Keys Management</h3>
                <input type="password" id="adminOpenaiKey" class="login-input" placeholder="OpenAI API Key">
                <input type="text" id="adminComposioKey" class="login-input" placeholder="Composio API Key">
                <button type="button" onclick="updateApiKeys()" class="login-button">Update API Keys</button>
            </div>
        </div>
    </div>

    <!-- Main Chat Application -->
    <div id="chatApp" class="chat-container hidden">
        <button id="adminButton" class="admin-button hidden">Admin</button>
        <button id="logoutButton" class="logout-button">Logout</button>
        
        <div class="header">
            <h1>🤖 Rebecca AI Assistant</h1>
            <p>Your personal AI with access to Gmail, Calendar, Drive & More</p>
        </div>

        <div id="status" class="status">
            Ready to connect - Enter your OpenAI API key below
        </div>

        <div id="messages" class="chat-messages">
            <div class="message system">
                Welcome to Rebecca! I'm your AI assistant with direct access to:
                <br>• Gmail - Check, send, and manage emails
                <br>• Calendar - View and schedule events  
                <br>• Drive - Find and organize files
                <br>• Sheets - Read and analyze data
                <br><br>Enter your OpenAI API key to get started!
            </div>
        </div>

        <div class="input-container">
            <div class="config-row">
                <input type="password" id="openaiKey" class="config-input" placeholder="Enter your OpenAI API Key (sk-...)">
                <input type="text" id="composioKey" class="config-input" placeholder="Composio API Key (optional)">
                <button id="connectBtn" class="connect-button">Connect</button>
            </div>

            <div class="input-row">
                <input type="text" id="messageInput" class="input-field" placeholder="Ask Rebecca anything..." disabled>
                <button id="sendBtn" class="send-button" disabled>Send</button>
            </div>

            <div class="suggestions">
                <div class="suggestion" onclick="sendMessage('Check my latest emails')">📧 Check emails</div>
                <div class="suggestion" onclick="sendMessage('What\'s my schedule today?')">📅 Today\'s schedule</div>
                <div class="suggestion" onclick="sendMessage('Find my recent Drive files')">📁 Recent files</div>
                <div class="suggestion" onclick="sendMessage('Send email to...')">✉️ Send email</div>
            </div>
        </div>
    </div>

    <script>
        // Authentication and user management
        let currentUser = null;
        let isConnected = false;
        let isTyping = false;
        let conversationHistory = [];
        let openaiApiKey = '';
        let composioApiKey = '';

        // Hardcoded admin credentials
        const ADMIN_EMAIL = 'ian@ishe-ltd.co.uk';
        const ADMIN_PASSWORD = '225Bs119Ej';

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const chatApp = document.getElementById('chatApp');
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');
        const adminButton = document.getElementById('adminButton');
        const logoutButton = document.getElementById('logoutButton');
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const connectBtn = document.getElementById('connectBtn');
        const openaiKeyInput = document.getElementById('openaiKey');
        const composioKeyInput = document.getElementById('composioKey');

        // Initialize app
        function init() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showChatApp();
                loadApiKeys();
                if (openaiApiKey) {
                    connect();
                }
            } else {
                showLoginPage();
            }

            // Setup event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);
            
            // Logout button
            logoutButton.addEventListener('click', handleLogout);
            
            // Admin button
            adminButton.addEventListener('click', openAdminPanel);
            
            // Chat functionality
            connectBtn.addEventListener('click', connect);
            sendBtn.addEventListener('click', () => sendMessage());
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();

            if (authenticateUser(email, password)) {
                currentUser = { email: email, isAdmin: email === ADMIN_EMAIL };
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                showChatApp();
                loadApiKeys();
                if (openaiApiKey) {
                    connect();
                }
                loginError.textContent = '';
            } else {
                loginError.textContent = 'Invalid email or password';
            }
        }

        function authenticateUser(email, password) {
            // Check admin credentials
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                return true;
            }

            // Check whitelisted users
            const whitelist = getWhitelist();
            return whitelist.some(user => user.email === email && user.password === password);
        }

        function getWhitelist() {
            const whitelist = localStorage.getItem('user_whitelist');
            return whitelist ? JSON.parse(whitelist) : [];
        }

        function saveWhitelist(whitelist) {
            localStorage.setItem('user_whitelist', JSON.stringify(whitelist));
        }

        function handleLogout() {
            localStorage.removeItem('current_user');
            currentUser = null;
            isConnected = false;
            conversationHistory = [];
            showLoginPage();
        }

        function showLoginPage() {
            loginPage.classList.remove('hidden');
            chatApp.classList.add('hidden');
            adminPanel.style.display = 'none';
            loginEmail.value = '';
            loginPassword.value = '';
            loginError.textContent = '';
        }

        function showChatApp() {
            loginPage.classList.add('hidden');
            chatApp.classList.remove('hidden');
            
            // Show admin button only for admin users
            if (currentUser && currentUser.isAdmin) {
                adminButton.classList.remove('hidden');
            } else {
                adminButton.classList.add('hidden');
            }
        }

        function loadApiKeys() {
            openaiApiKey = localStorage.getItem('openai_api_key') || '';
            composioApiKey = localStorage.getItem('composio_api_key') || '';

            if (openaiApiKey) {
                openaiKeyInput.value = '••••••••••••••••';
            }
            if (composioApiKey) {
                composioKeyInput.value = '••••••••••••••••';
            }
        }

        // Admin Panel Functions
        function openAdminPanel() {
            if (!currentUser || !currentUser.isAdmin) return;
            
            updateUserList();
            updateAdminApiKeys();
            adminPanel.style.display = 'flex';
        }

        function closeAdminPanel() {
            adminPanel.style.display = 'none';
        }

        function updateUserList() {
            const userList = document.getElementById('userList');
            const whitelist = getWhitelist();
            
            userList.innerHTML = '';
            
            // Add admin user (non-removable)
            const adminItem = document.createElement('div');
            adminItem.className = 'user-item';
            adminItem.innerHTML = `
                <span>${ADMIN_EMAIL} (Admin)</span>
                <span style="color: #48bb78; font-size: 12px;">Protected</span>
            `;
            userList.appendChild(adminItem);
            
            // Add whitelisted users
            whitelist.forEach((user, index) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <span>${user.email}</span>
                    <button class="remove-user" onclick="removeUser(${index})">Remove</button>
                `;
                userList.appendChild(userItem);
            });
        }

        function addUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            if (email === ADMIN_EMAIL) {
                alert('Cannot add admin email to whitelist');
                return;
            }
            
            const whitelist = getWhitelist();
            
            // Check if user already exists
            if (whitelist.some(user => user.email === email)) {
                alert('User already exists');
                return;
            }
            
            whitelist.push({ email: email, password: password });
            saveWhitelist(whitelist);
            updateUserList();
            
            // Clear form
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPassword').value = '';
        }

        function removeUser(index) {
            const whitelist = getWhitelist();
            whitelist.splice(index, 1);
            saveWhitelist(whitelist);
            updateUserList();
        }

        function updateAdminApiKeys() {
            document.getElementById('adminOpenaiKey').value = openaiApiKey ? '••••••••••••••••' : '';
            document.getElementById('adminComposioKey').value = composioApiKey ? '••••••••••••••••' : '';
        }

        function updateApiKeys() {
            const newOpenAIKey = document.getElementById('adminOpenaiKey').value.trim();
            const newComposioKey = document.getElementById('adminComposioKey').value.trim();
            
            if (newOpenAIKey && newOpenAIKey !== '••••••••••••••••') {
                openaiApiKey = newOpenAIKey;
                localStorage.setItem('openai_api_key', openaiApiKey);
                openaiKeyInput.value = '••••••••••••••••';
            }
            
            if (newComposioKey && newComposioKey !== '••••••••••••••••') {
                composioApiKey = newComposioKey;
                localStorage.setItem('composio_api_key', composioApiKey);
                composioKeyInput.value = '••••••••••••••••';
            }
            
            // Reconnect with new keys
            if (openaiApiKey) {
                connect();
            }
            
            updateAdminApiKeys();
            alert('API keys updated successfully');
        }

        // Original chat functionality
        function connect() {
            const newOpenAIKey = openaiKeyInput.value.trim();
            const newComposioKey = composioKeyInput.value.trim();

            if (!newOpenAIKey || newOpenAIKey === '••••••••••••••••') {
                if (!openaiApiKey) {
                    updateStatus('Please enter your OpenAI API key', 'error');
                    return;
                }
            } else {
                openaiApiKey = newOpenAIKey;
                localStorage.setItem('openai_api_key', openaiApiKey);
            }

            if (newComposioKey && newComposioKey !== '••••••••••••••••') {
                composioApiKey = newComposioKey;
                localStorage.setItem('composio_api_key', composioApiKey);
            }

            testConnection();
        }

        async function testConnection() {
            updateStatus('Connecting to OpenAI...', 'connecting');

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${openaiApiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    isConnected = true;
                    updateStatus('✅ Connected! Rebecca is ready to help.', 'connected');
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    messageInput.placeholder = "Ask Rebecca anything...";
                    messageInput.focus();

                    // Hide keys for security
                    openaiKeyInput.value = '••••••••••••••••';
                    if (composioApiKey) composioKeyInput.value = '••••••••••••••••';

                } else {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }
            } catch (error) {
                updateStatus(`❌ Connection failed: ${error.message}`, 'error');
                isConnected = false;
            }
        }

        function updateStatus(message, type = '') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function addMessage(text, sender = 'user') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            messageEl.textContent = text;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            if (sender !== 'system') {
                conversationHistory.push({
                    role: sender === 'user' ? 'user' : 'assistant',
                    content: text
                });
            }
        }

        function showTyping() {
            if (isTyping) return;
            isTyping = true;

            const typingEl = document.createElement('div');
            typingEl.className = 'message typing';
            typingEl.id = 'typing';
            typingEl.textContent = 'Rebecca is thinking...';
            messagesEl.appendChild(typingEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function hideTyping() {
            const typingEl = document.getElementById('typing');
            if (typingEl) {
                typingEl.remove();
            }
            isTyping = false;
        }

        async function sendMessage(text = null) {
            if (!isConnected) {
                updateStatus('Please connect first', 'error');
                return;
            }

            const message = text || messageInput.value.trim();
            if (!message) return;

            messageInput.value = '';
            addMessage(message, 'user');
            showTyping();

            try {
                const isProductivityRequest = /email|gmail|calendar|schedule|drive|file|sheet|spreadsheet/i.test(message);

                let systemPrompt = `You are Rebecca, a professional AI assistant. Be direct, efficient, and helpful.`;

                if (isProductivityRequest && composioApiKey) {
                    systemPrompt = `You are Rebecca, a professional AI assistant with access to Gmail, Calendar, Drive, and Sheets via Composio tools. When users ask about emails, calendar, files, or data:
1. Acknowledge the request
2. Explain that you're checking their accounts
3. For now, provide helpful guidance and suggest they connect their accounts to Rube.app for full functionality
4. Be specific about what you would do with full access

You can help with productivity tasks like:
• Check, send, and manage emails
• View and schedule calendar events  
• Find and organize Drive files
• Read and analyze spreadsheet data

Always be concise but thorough.`;
                }

                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...conversationHistory.slice(-10),
                    { role: 'user', content: message }
                ];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openaiApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: messages,
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const assistantResponse = data.choices[0].message.content;

                hideTyping();
                addMessage(assistantResponse, 'assistant');

            } catch (error) {
                hideTyping();
                addMessage(`Sorry, I encountered an error: ${error.message}`, 'system');
                console.error('Error:', error);
            }
        }

        // Auto-save conversation
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('conversation_history', JSON.stringify(conversationHistory));
        });

        // Load conversation history
        function loadConversationHistory() {
            const savedHistory = localStorage.getItem('conversation_history');
            if (savedHistory) {
                try {
                    conversationHistory = JSON.parse(savedHistory);
                } catch (e) {
                    console.error('Failed to load conversation history');
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            init();
            loadConversationHistory();
        });
    </script>
</body>
</html>